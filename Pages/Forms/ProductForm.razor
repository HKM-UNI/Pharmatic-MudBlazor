@page "/productos/agregar"
@page "/productos/editar/{id}"
@using Pharmatic.DTOs;
@using Pharmatic.Services;
@layout MainLayout
@inject NavigationManager _navigationManager
@inject ProductService _productService
@inject SharedData _data
@inject ISnackbar Snackbar

@inject TagService _tagService
@inject CategoryService _catService
@inject SubCategoryService _subcatService

<MudPaper Class="ma-5">
    <MudAppBar Elevation="0" Fixed="false" Style="border-radius: 15px;">

        <MudSpacer />

        <MudButton Class="rounded-pill" ButtonType="ButtonType.Submit" Size="Size.Large" Variant="Variant.Filled"
                   Color="Color.Error" Style="margin-right:10px;" OnClick="OnCancelClicked">
            Cancelar
        </MudButton>

        <MudButton Class="rounded-pill" ButtonType="ButtonType.Submit" Size="Size.Large" Variant="Variant.Filled"
                   Color="Color.Primary" OnClick="OnSubmitClicked">
            @SubmitButtonLabel
        </MudButton>
    </MudAppBar>
    <MudGrid Class="pa-5">
        <MudItem xs="6">
                <MudTextField T="string" @bind-Value="_product.Name" Label="Nombre" Class="my-5" Variant="Variant.Outlined"/>
                <MudTextField T="string" @bind-Value="_product.Description" Label="Descripción" Lines="5" Class="my-5" Variant="Variant.Outlined" />
                <MudSelect T="string" @bind-Value="_product.Category.Name" Label="Categoría" AnchorOrigin="Origin.BottomCenter" Class="my-5" Variant="Variant.Outlined">
                    @foreach (var cat in cat_list)
                    {
                        <MudSelectItem Value="@cat.Name"/>
                    }
                </MudSelect>
                <MudSelect T="string" @bind-Value="_product.SubCategory.Name" Label="SubCategoría" AnchorOrigin="Origin.BottomCenter" Class="my-5" Variant="Variant.Outlined">
                    @foreach (var subcat in subcat_list)
                    {
                        <MudSelectItem Value="@subcat.Name"/>
                    }
                    
                </MudSelect>
                <MudSelect T="string" Label="Tags" AnchorOrigin="Origin.BottomCenter" MultiSelection="true" Class="my-5" Variant="Variant.Outlined" @bind-SelectedValues="selected_tags">
                    @foreach (var tag in tag_list)
                    {
                        <MudSelectItem Value="@tag.Name"/>
                    }
                </MudSelect>     
        </MudItem>

        <MudItem xs="6">
            <MudCard Class="pa-5">
                <MudCardMedia Image="@photoUrl" Height="450" Style="background-size: contain; background-color: gray;"/>

                <MudFileUpload T="IBrowserFile" OnFilesChanged="OnInputFileChanged">
                    <ButtonTemplate>
                            <MudButton HtmlTag="label"
                                       Variant="Variant.Filled"
                                       Color="Color.Info"
                                       Class="rounded-pill ma-2"
                                       for="@context">
                                Subir Foto
                            </MudButton>
                    </ButtonTemplate>
                        <SelectedTemplate>
                            <MudButton Class="rounded-pill ma-2" ButtonType="ButtonType.Submit" Size="Size.Large"
                                       Variant="Variant.Filled" Color="Color.Error" OnClick="ClearFile">
                                Limpiar
                            </MudButton>
                            @if (photo != null)
                            {
                                <MudText>@context.Name</MudText>
                            }
                            else
                            {
                                <MudText>@SubmitPhotoLabel</MudText>
                            }
                        </SelectedTemplate>
                </MudFileUpload>
                    
            </MudCard>
        </MudItem>
        
    </MudGrid>

</MudPaper>

@code {
    public ProductDTO _product { get; set; } = new ProductDTO();
    public ProductPATCHDTO _productpatch { get; set; } = new ProductPATCHDTO();
    private IBrowserFile? photo;
    private string photoUrl = string.Empty;
    private string photoB64 = string.Empty;

    [Parameter]
    public string Id { get; set; }
    bool IsEditMode => !string.IsNullOrEmpty(Id);
    string SubmitButtonLabel => IsEditMode ? "Editar" : "Guardar";
    string SubmitPhotoLabel => IsEditMode ? "Al no subir foto se dejará la anterior" : "Sin foto";
    string SubmitBreadCrumbLabel => IsEditMode ? "Editar producto" : "Nuevo producto";

    private List<CategoryDTO> cat_list = new List<CategoryDTO>();
    private List<SubCategoryDTO> subcat_list = new List<SubCategoryDTO>();
    private List<TagDTO> tag_list = new List<TagDTO>();

    private IEnumerable<string> selected_tags { get; set; } = new HashSet<string>();

    private async Task OnInputFileChanged(InputFileChangeEventArgs e)
    {
        photo = e.File;
        photoB64 = await ConvertToB64(photo);
        photoUrl = ConvertToUrl(photoB64);
    }

    private string ConvertToUrl(string base64)
    {
        var url = $"data:{photo?.ContentType};base64,{base64}";
        return url;
    }

    private async Task<string> ConvertToB64(IBrowserFile file)
    {
        using var stream = file.OpenReadStream();
        using var memoryStream = new MemoryStream();
        await stream.CopyToAsync(memoryStream);

        return Convert.ToBase64String(memoryStream.ToArray());
    }

    private void OnCancelClicked()
    {
        _navigationManager.NavigateTo("/productos");
    }

    private async Task OnSubmitClicked()
    {
        if (!IsEditMode)
        {
            var prod = await AddProduct();

            if (prod != null)
            {
                if (!string.IsNullOrEmpty(photoB64)) await AddPhoto(Convert.ToString(prod.ProductNo), photoB64);

                Snackbar.Add("Producto creado correctamente", Severity.Success);
                _navigationManager.NavigateTo("/productos");
            }
            else Snackbar.Add("Error al crear producto", Severity.Warning);
        }
        else
        {
            var prod = await EditProduct();

            bool photo_update = false;
            if (!string.IsNullOrEmpty(photoB64))
            {
                photo_update = await AddPhoto(Id, photoB64);
            }

            if(photo_update) Snackbar.Add("Foto actualizada correctamente", Severity.Success);

            if (prod != null)
            {
                Snackbar.Add("Producto actualizado correctamente", Severity.Success);
                _navigationManager.NavigateTo($"/productos/detalle/{prod.ProductNo}");
            }
            else Snackbar.Add("Error al editar producto", Severity.Warning);
        }

    }

    private async Task<ProductDTO> AddProduct()
    {
        var selectedCategory = cat_list.FirstOrDefault(cat => cat.Name == _product.Category?.Name);
        _product.Category.CategoryNo = selectedCategory.CategoryNo;

        var selectedSubCategory = subcat_list.FirstOrDefault(subcat => subcat.Name == _product.SubCategory?.Name);
        _product.SubCategory.SubcategoryNo = selectedSubCategory.SubcategoryNo;

        var selectedTags = tag_list
            .Where(tag => selected_tags.Contains(tag.Name))
            .Select(tag => new TagDTO { TagNo = tag.TagNo, Name = tag.Name })
            .ToList();

        _product.Tags = selectedTags;

        var result = await _productService.CreateProduct(_product);
        return result;
    }

    private async Task<ProductDTO> EditProduct()
    {
        var selectedCategory = cat_list.FirstOrDefault(cat => cat.Name == _product.Category?.Name);
        _product.Category.CategoryNo = selectedCategory.CategoryNo;

        var selectedSubCategory = subcat_list.FirstOrDefault(subcat => subcat.Name == _product.SubCategory?.Name);
        _product.SubCategory.SubcategoryNo = selectedSubCategory.SubcategoryNo;

        var selectedTags = tag_list
            .Where(tag => selected_tags.Contains(tag.Name))
            .Select(tag => new TagDTO { TagNo = tag.TagNo, Name = tag.Name })
            .ToList();

        _product.Tags = selectedTags;

        _productpatch.name = _product.Name;
        _productpatch.description = _product.Description;
        _productpatch.tags = _product.Tags;
        _productpatch.subcategory = _product.SubCategory;
        _productpatch.category = _product.Category;

        var result = await _productService.EditProduct(int.Parse(Id), _productpatch);
        return result;
    }

    private async Task<bool> AddPhoto(string id, string photo64)
    {
        var result = await _productService.AddPhoto(id, photo.Name, photo.ContentType, photoB64);
        return result;
    }

    private void ClearFile()
    {
        photo = null;
        photoUrl = string.Empty;
    }

    private async Task GetSelectData()
    {
        var cat_result = await _catService.CategoryList();
        cat_list = cat_result!;

        var subcat_result = await _subcatService.SubCategoryList();
        subcat_list = subcat_result!;

        var tag_result = await _tagService.TagList();
        tag_list = tag_result!;
    }

    protected override async Task OnInitializedAsync()
    {
        _data.Items = new List<BreadcrumbItem>
        {
            new BreadcrumbItem("Home", href: "/dashboard", icon: Icons.Material.Filled.Home),
            new BreadcrumbItem("Producto", href: "/productos"),
            new BreadcrumbItem(SubmitBreadCrumbLabel, href: null, disabled:true),
        };

        await GetSelectData();

        if (IsEditMode)
        {
            _product = await _productService.SearchProduct(Id);
            if (_product.Category == null) _product.Category = new CategoryDTO();
            if (_product.SubCategory == null) _product.SubCategory = new SubCategoryDTO();
            if(_product.Tags != null) selected_tags = _product.Tags.Select(tag => tag.Name);
        }
    }
}
