@page "/productos/detalle/{id}"
@using Pharmatic.DTOs;
@using Pharmatic.Services;
@layout MainLayout
@inject ProductService _productService
@inject LotService _lotService
@inject NavigationManager _navigationManager
@inject SharedData _data

<MudPaper Class="ma-3">
    <MudAppBar Elevation="0" Fixed="false" Style="border-radius: 15px;">

        <MudSpacer />

        <MudButton Class="rounded-pill" Variant="Variant.Filled" ButtonType="ButtonType.Submit" Size="Size.Large"
                   Color="Color.Error">
            Eliminar Producto
        </MudButton>

        <MudDivider DividerType="DividerType.Middle"></MudDivider>

        <MudButton Class="rounded-pill" Variant="Variant.Filled" ButtonType="ButtonType.Submit" Size="Size.Large"
                   Color="Color.Primary">
            Editar Producto
        </MudButton>
    </MudAppBar>
    <MudGrid Class="pa-5">
        <MudItem xs="3">
            <MudImage Src="@product.ImageUrl" Elevation="3" 
                Fluid="true"/>
        </MudItem>

        <MudItem xs="9">

            <MudText Typo="Typo.h3">@product.Name</MudText>
            <MudText Typo="Typo.h4">@product.Category?.Name - @product.SubCategory?.Name</MudText>
                
            @if (product.Tags?.Count > 0)
            {
                @foreach (var tag in product.Tags)
                {
                    <MudChip Color="Color.Primary" Size="Size.Medium">@tag.Name</MudChip>
                }
            }
            else
            {
                <MudChip Color="Color.Error" Size="Size.Medium">Sin etiquetas</MudChip>
            }
            <MudText Typo="Typo.body1">@product.Description</MudText>
        </MudItem>

        <MudItem xs="12">
            <MudText Typo="Typo.h6" Inline="true">Lotes: @product.LotCount</MudText>
            <MudButton Class="rounded-pill mx-3" Variant="Variant.Filled" ButtonType="ButtonType.Submit" Size="Size.Large"
                       Color="Color.Primary">
                Agregar Lote
            </MudButton>
        </MudItem>

        @foreach(var lot in lot_list)
        {
            <MudItem xs="6">
                <MudCard Style="background-color: #F5F5F5">
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudText Typo="Typo.h6">Composicion: @lot.Composition?.Dose?.Name @lot.Composition?.Roa?.Description @lot.Composition?.Measure?.Unit @lot.Composition?.ContentSize</MudText>
                            <MudText Typo="Typo.h6">Stock: @lot.Stock Venta: @lot.SellingPrice C$ Compra: @lot.PurchasePrice C$</MudText>
                            <MudText Typo="Typo.h6" Color="Color.Warning" Inline="true"> 
                                <MudIcon Icon="@Icons.Material.Outlined.PersonOutline" Size="Size.Small" /> @lot.Provider?.Name 
                            </MudText>
                            <MudText Typo="Typo.h6" Inline="true"> @lot.Consign </MudText>
                            <MudText Typo="Typo.h6" Inline="true" Color="Color.Error">
                                <MudIcon Icon="@Icons.Material.Filled.DateRange" Size="Size.Small" /> @lot.ExpirationDate.ToString("dd/MM/yyyy")
                            </MudText>
                        </CardHeaderContent>
                    </MudCardHeader>
                </MudCard>
            </MudItem>
        }

    </MudGrid>

</MudPaper>

@code {
    [Parameter]
    public string Id { get; set; }

    private List<LotDTO> lot_list = new List<LotDTO>();
    private ProductDTO product = new ProductDTO();

    protected override async Task OnInitializedAsync()
    {
        _data.Items = new List<BreadcrumbItem>
        {
            new BreadcrumbItem("Home", href: "/dashboard", icon: Icons.Material.Filled.Home),
            new BreadcrumbItem("Productos", href: "/productos"),
            new BreadcrumbItem("Detalle producto", href: null, disabled: true)
        };

        await GetLots();
        product = await _productService.SearchProduct(Id);
    }

    private async Task GetLots()
    {
        var result = await _lotService.LotList(Id);
        lot_list = result!;

    }
}
